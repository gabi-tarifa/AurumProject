<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurum</title>
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/128/3975/3975233.png" type="image/x-icon">
    <style>
body {
    background: #0f1e34;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px; /* respiro extra */
}
body.claro {
    background: #b9d5ff;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px; /* respiro extra */
}
#aula-container {
    width: 600px;
    margin: auto;
    background: #0f1b3d;
    color: white;
    padding: 20px;
    border-radius: 20px;

    box-shadow: 
        0 4px 12px rgba(54, 53, 53, 0.666),   /* sombra padrão */
        0 0 20px rgba(218, 164, 26, 0.588); /* brilho dourado */
}
#aula-container.claro {
    width: 600px;
    margin: auto;
    background: #254190;
    color: white;
    padding: 20px;
    border-radius: 20px;

    box-shadow: 
        0 4px 12px rgba(54, 53, 53, 0.666),   /* sombra padrão */
        0 0 20px rgba(218, 164, 26, 0.588); /* brilho dourado */
}

#progresso {
    width: 100%;
    background: #000000;
    height: 8px;
    border-radius: 4px;
    margin: 10px 0;
}
#barra-progresso {
    height: 100%;
    background: darkgoldenrod;
    width: 0%;
    border-radius: 4px;
    transition: width 0.3s ease;
}
#conteudo {
    margin: 20px 0;
}
#navegacao {
    text-align: right;
}
#navegacao button {
    background: darkgoldenrod;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
}
#navegacao button:disabled {
    background: rgb(104, 77, 7);
    cursor: not-allowed;
}
#conteudo button {
    display: block;
    margin: 8px 0;
    padding: 10px;
    background: #2b3d74;
    color: white;
    border: 2px solid #2f3b74;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.5s ease, border-color 0.5s ease;
}
#conteudo button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
</head>
<body {%if tema == 'cla'%} class="claro" {%endif%}>
    <div id="aula-container" {%if tema == 'cla'%} class="claro" {%endif%}>
  <h2 id="aula-titulo">{{ _(tarefa.descricao) }}</h2>
  <div id="progresso">
    <div id="barra-progresso"></div>
  </div>

  <div id="conteudo"></div>

  <div id="navegacao">
    <button id="btn-voltar" disabled>{{ _('Voltar') }}</button>
    <button id="btn-avancar">{{ _('Avançar') }}</button>
  </div>
</div>

    <script> window.SONS_ATIVOS = {{ 'true' if sons_ativos else 'false' }}; </script>
    <script src="{{ url_for('static', filename='js/sounds.js') }}"></script>
<script>
const blocos = {{ blocos_json|tojson }};
const tarefaId = {{ tarefa.numero_tarefa }};
const moduloId = {{ tarefa.id_modulo }};

let indice = 0;
let totalQuestoes = blocos.filter(b => b.tipo === "quiz").length;
let acertos = 0;
let respondidas = 0;

const conteudoEl = document.getElementById("conteudo");
const barraProgresso = document.getElementById("barra-progresso");
const btnAvancar = document.getElementById("btn-avancar");
const btnVoltar = document.getElementById("btn-voltar");

// Armazena as respostas: { indice: {correta: bool, escolhida: index} }
let respostas = {};

function renderizarBloco() {
    const bloco = blocos[indice];
    barraProgresso.style.width = ((indice) / blocos.length * 100) + "%";

    conteudoEl.innerHTML = "";

    if (bloco.tipo === "texto") {
        conteudoEl.innerHTML = bloco.conteudo;
        btnAvancar.disabled = false;
    } else if (bloco.tipo === "quiz") {
        conteudoEl.innerHTML = `<h3>${bloco.pergunta}</h3>`;
        btnAvancar.disabled = true;

        bloco.alternativas.forEach((alt, i) => {
            const btn = document.createElement("button");
            btn.textContent = alt.texto;

            // Se já respondeu antes, aplica estilo e trava
            if (respostas[indice]) {
                if (respostas[indice].escolhida === i) {
                    if (respostas[indice].correta) {
                        btn.style.background = "green";
                        btn.style.borderColor = "darkgreen";
                    } else {
                        btn.style.background = "crimson";
                        btn.style.borderColor = "darkred";
                    }
                }
                btn.disabled = true; // trava todos
                btnAvancar.disabled = false; // pode avançar sem responder de novo
            }

            btn.onclick = () => {
                if (!respostas[indice]) {
                    respostas[indice] = {
                        correta: alt.correta,
                        escolhida: i
                    };

                    respondidas++;
                    if (alt.correta) acertos++;

                    [...conteudoEl.querySelectorAll("button")].forEach((b, j) => {
                        b.disabled = true;
                        if (j === i) {
                            if (alt.correta) {
                                b.style.background = "green";
                                b.style.borderColor = "darkgreen";
                            } else {
                                b.style.background = "crimson";
                                b.style.borderColor = "darkred";
                            }
                        }
                    });

                    btnAvancar.disabled = false;

                    // avança sozinho se quiser
                    setTimeout(() => {
                        if (indice < blocos.length - 1) {
                            indice++;
                            renderizarBloco();
                        }
                    }, 800);
                }
            };

            conteudoEl.appendChild(btn);
        });
    }

    btnVoltar.disabled = indice === 0;
}

btnAvancar.addEventListener("click", () => {
    if (indice < blocos.length - 1) {
        indice++;
        renderizarBloco();
    } else {
        let taxa = totalQuestoes > 0 ? (acertos / totalQuestoes) * 100 : 100;

if (taxa >= 70) {
    fetch(`/concluir_tarefa/modulo_${moduloId}/tarefa_${tarefaId}`, { method: "POST" })
        .then(() => {
            window.location.href = `/licao_sucesso/${tarefaId}/${moduloId}`;
        })
        .catch(() => {
            alert("Erro ao concluir a aula.");
        });
} else {
    window.location.href = `/licao_falha/${tarefaId}/${moduloId}`;
}
    }
});

btnVoltar.addEventListener("click", () => {
    if (indice > 0) {
        indice--;
        renderizarBloco();
    }
});

renderizarBloco();
</script>
<script>
  // Valor dinâmico vindo do backend
  window.MUSICA_ATIVA = {{ 'true' if musica_ativa else 'false' }};
  const musicadasessao = {{ musica_tocada | tojson }};
</script>
<script src="{{ url_for('static', filename='js/musics.js') }}"></script>

</body>

</html>