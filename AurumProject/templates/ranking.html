<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ranking</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/aurum.css') }}"
    />
    <link
      rel="shortcut icon"
      href="https://cdn-icons-png.flaticon.com/128/3975/3975233.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/popup.css') }}" />
  </head>

  <body {%if tema == 'cla'%} class="claro" {%endif%}>
    <div class="containerTP" id="rank-screen">
      <!-- MENU LATERAL -->
      <nav class="sidebar {%if tema == 'cla'%} claro {%endif%}">
        <a href="{{ url_for('starting_page') }}">
          <div class="menu-item">
            <img
              src="{{ url_for('static', filename='img/open-book.png') }}"
              class="icon"
              alt="Aprender"
            />
            <span>{{ _('Aprender') }}</span>
          </div>
        </a>

        <a href="{{ url_for('quiz_page') }}">
          <div class="menu-item">
            <img
              src="{{ url_for('static', filename='img//working-hours.png') }}"
              class="icon"
              alt="Quiz"
            />
            <span>{{ _('Quiz') }}</span>
          </div>
        </a>

        <a href="{{ url_for('ranking_page') }}">
          <div class="menu-item active {%if tema == 'cla'%} claro {%endif%}">
            <img
              src="{{ url_for('static', filename='img//trophy.png') }}"
              class="icon"
              alt="Ranking"
            />
            <span>{{ _('Ranking') }}</span>
          </div>
        </a>

        <a href="{{ url_for('perfil_page') }}">
          <div class="menu-item">
            <img
              src="{{ url_for('static', filename='img//profile.png') }}"
              class="icon"
              alt="Perfil"
            />
            <span>{{ _('Perfil') }}</span>
          </div>
        </a>

        <a href="{{ url_for('store_page') }}">
          <div class="menu-item">
            <img
              src="{{ url_for('static', filename='img//store.png') }}"
              class="icon"
              alt="Loja"
            />
            <span>{{ _('Loja') }}</span>
          </div>
        </a>

        <div class="menu-item" id="openMais">
          <img
            src="{{ url_for('static', filename='img//info.png') }}"
            class="icon"
            alt="Mais"
          />
          {{ _('Mais') }}
      <!-- Submenu do bot√£o "Mais" -->
      <div class="submenu-mais oculto" id="submenuMais">
        <ul>
          <li>
            <a href="/ajuda">
              <img
                src="{{ url_for('static', filename='img//help.png') }}"
                class="smallimage"
                alt="Ajuda"
              />
              <span class="ajuda">{{ _('Ajuda') }}</span>
            </a>
          </li>
          <li>
            <a href="/config">
              <img
                src="{{ url_for('static', filename='img//gear.png') }}"
                class="smallimage"
                alt="Configura√ß√µes"
              />
              <span class="config">{{ _('Configura√ß√µes') }}</span>
            </a>
          </li>
          <li>
            <a href="/logout">
              <img
                src="{{ url_for('static', filename='img//exit.png') }}"
                class="smallimage"
                alt="Sair"
              />
              <span class="sair">{{ _('Sair') }}</span>
            </a>
          </li>
        </ul>
      </div>
        </div>
      </nav>


      <main class="main-content" id="rankingGeral">
        <section class="ranking-box {%if tema == 'cla'%} claro {%endif%}">
          <div class="ranking-header {%if tema == 'cla'%} claro {%endif%}">
            <h1 class="active" id="btnGeralgrl">{{ _('RANKING SEMANAL') }}</h1>
            <h1 id="btnAmigosgrl">{{ _('RANKING DE AMIGOS') }}</h1> 
          </div>

          <ul class="ranking-list {%if tema == 'cla'%} claro {%endif%}">
            <span class="cabecalho {%if tema == 'cla'%} claro {%endif%}">
              <span></span>
              <span>{{ _('Apelido') }}</span>
              <span>{{ _('Pontos') }}</span>
              <span>{{ _('Recompensas') }}</span>
            </span>

            {% for usuario in ranking %}
              {% set classes = [] %}
              {% if loop.index == 1 %}
                {% set _ = classes.append('first') %}
              {% elif loop.index == 2 %}
                {% set _ = classes.append('second') %}
              {% elif loop.index == 3 %}
                {% set _ = classes.append('third') %}
              {% endif %}
              {% if usuario.id == current_user.id %}
                {% set _ = classes.append('ownplayer') %}
              {% endif %}
              {%if tema == 'cla'%}
                {% set _ = classes.append('claro') %}
              {%endif%}

              <li class="{{ ' '.join(classes) }}">
                <span>#{{ loop.index }}</span>

                <span class="icon">
                  <div class="profile-hover-container" data-user-id="{{ usuario.id }}">
                    {% if "http" in usuario.profilepicture %}
                      <img src="{{ usuario.profilepicture }}" alt="Foto" class="profile-picture">
                    {% else %}
                      <img src="{{ url_for('static', filename=usuario.profilepicture) }}" alt="Foto" class="profile-picture">
                    {% endif %}

                    {% if usuario.id != current_user.id %}
                      {% set id1, id2 = (current_user.id, usuario.id) | sort %}
                      {% set amizade = amizades.get((id1, id2)) %}
                      <div class="friend-status">
                        {% if not amizade %}
                          ü§ù
                        {% elif amizade.status == 'pendente' %}
                          üëã
                        {% elif amizade.status == 'aceita' %}
                          üë•
                        {% endif %}
                      </div>
                    {% endif %}

                    <div class="profile-hover-box" role="dialog" aria-hidden="true">
                    {% if "http" in usuario.profilepicture %}
                      <img src="{{ usuario.profilepicture }}" alt="Foto" class="profile-picture">
                    {% else %}
                      <img src="{{ url_for('static', filename=usuario.profilepicture) }}" alt="Foto" class="hover-picture">
                    {% endif %}
                      <div class="hover-info">
                        <span class="hover-name">{{ usuario.nome }}</span>

                        {% if usuario.id != current_user.id %}
                          {% if not amizade %}
                            <button
                              class="friend-request-btn"
                              data-user-id="{{ usuario.id }}"
                            >
                              ü§ù {{ gettext('Solicitar amizade') }}
                            </button>
                          {% elif amizade.status == 'pendente' %}
                            {% if current_user.id == amizade.id_usuario2 %}
                              <div class="friend-action">
                                <button
                                  class="accept-btn"
                                  data-user-id="{{ usuario.id }}"
                                >
                                  ‚úÖ {{ gettext('Aceitar') }}
                                </button>
                                <button
                                  class="reject-btn"
                                  data-user-id="{{ usuario.id }}"
                                >
                                  ‚ùå {{ gettext('Recusar') }}
                                </button>
                              </div>
                            {% else %}
                              <button class="waiting-btn" disabled>
                                ‚è≥ {{ gettext('Aguardando resposta') }}
                              </button>
                            {% endif %}
                          {% elif amizade.status == 'aceita' %}
                            <button class="friend-btn" disabled>
                              üë• {{ gettext('Amigos') }}
                            </button>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </span>

                <span class="name">{{ usuario.nome }}</span>
                <span>{{ usuario.pontos_semanais }}</span>
                <span>{{ recompensas[loop.index0] }}</span>

                <div class="coin-bg {%if tema == 'cla'%} claro {%endif%}">
                  <img
                    src="{{ url_for('static', filename='img/stack-of-coins.png') }}"
                    class="coin-icon"
                    alt="moedas"
                  />
                </div>
              </li>
            {% endfor %}
          </ul>
        </section>
      </main>

      <main class="main-content oculto" id="rankingAmigos">
        <section class="ranking-box {%if tema == 'cla'%} claro {%endif%}">

          <div class="ranking-header {%if tema == 'cla'%} claro {%endif%}">
            <h1 id="btnGeralamg">{{ _('RANKING SEMANAL') }}</h1>
            <h1 id="btnAmigosamg" class="active">{{ _('RANKING DE AMIGOS') }}</h1>
          </div>

          <ul class="ranking-list {%if tema == 'cla'%} claro {%endif%}">
            <span class="cabecalho {%if tema == 'cla'%} claro {%endif%}">
              <span></span>
              <span>{{ _('Apelido') }}</span>
              <span>{{ _('Pontos') }}</span>
              <span>{{ _('Tempo de Amizade') }}</span>
            </span>

            {% for usuario in rankingamigos %}
              {% set classes = [] %}
              {% if loop.index == 1 %}
                {% set _ = classes.append('first') %}
              {% elif loop.index == 2 %}
                {% set _ = classes.append('second') %}
              {% elif loop.index == 3 %}
                {% set _ = classes.append('third') %}
              {% endif %}

              {% if usuario.id == current_user.id %}
                {% set _ = classes.append('ownplayer') %}
              {% endif %}

              {%if tema == 'cla'%}
                {% set _ = classes.append('claro') %}
              {%endif%}

              <li class="{{ ' '.join(classes) }}">
                <span>#{{ loop.index }}</span>

                <span class="icon">
                  <div class="profile-hover-container" data-user-id="{{ usuario.id }}">
                    
        {% if "http" in usuario.profilepicture %}
          <img src="{{ usuario.profilepicture }}" alt="Foto" class="profile-picture">
        {% else %}
          <img src="{{ url_for('static', filename=usuario.profilepicture) }}" alt="Foto" class="profile-picture">
        {% endif %}

                    {% if usuario.id != current_user.id %}
                      {% set id1, id2 = (current_user.id, usuario.id) | sort %}
                      {% set amizade = amizadesamigos.get((id1, id2)) %}
                      <div class="friend-status">üë•</div>
                    {% endif %}

                    <div class="profile-hover-box" role="dialog" aria-hidden="true">
                    {% if "http" in usuario.profilepicture %}
                      <img src="{{ usuario.profilepicture }}" alt="Foto" class="profile-picture">
                    {% else %}
                      <img src="{{ url_for('static', filename=usuario.profilepicture) }}" alt="Foto" class="hover-picture">
                    {% endif %}
                      <div class="hover-info">
                        <span class="hover-name">{{ usuario.nome }}</span>
                        {% if usuario.id != current_user.id %}
                          <button class="friend-btn" disabled>
                            üë• {{ gettext('Amigos') }}
                          </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </span>

                <span class="name">{{ usuario.nome }}</span>
                <span>{{ usuario.pontos_semanais }}</span>

                {% if usuario.id == current_user.id %}
                  <span>-</span>
                {% else %}
                  <span>{{ tempos_amizade[usuario.id] }} {{ gettext('dias') }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </section>
      </main>

      <aside class="info-box">
        <div class="info {%if tema == 'cla'%} claro {%endif%}">
          <span class="golden">{{ coins }}</span>
          <img
            src="{{ url_for('static', filename='img//stack-of-coins.png') }}"
            class="icon"
          />
        </div>

        <div class="info  {%if tema == 'cla'%} claro {%endif%}">
          <img
            src="{{ url_for('static', filename='img//calendar.png') }}"
            class="icon"
          />
          <span class="golden">{{ ofensiva.sequencia_atual }}</span>
          <br />
          <span class="darkgolden">
            {% if ofensiva.sequencia_atual == 1 %}
              {{ _('Dia consecutivo') }}
            {% else %}
              {{ _('Dias consecutivos') }}
            {% endif %}
          </span>
        </div>

        <div class="info  {%if tema == 'cla'%} claro {%endif%}">
          <img
            src="{{ url_for('static', filename='img//award.png') }}"
            alt="Trofeu"
            class="icon"
          />
          <span class="golden">{{ ofensiva.recorde }}</span>
          <br />
          <span class="darkgolden">{{ _('Recorde') }}</span>
        </div>

        <div class="info {%if tema == 'cla'%} claro {%endif%}">
          <span class="golden">{{ pontos }}</span>
          <br />
          <span class="darkgolden">{{ _('Total de Aurum Points') }}</span>
        </div>

        <div class="info  {%if tema == 'cla'%} claro {%endif%}">
          <span">{{ _('Registro Semanal') }}</span>
          <div class="registro-semanal">
            {% for concluido in ofensiva.dias_semana %}
              {% set index = loop.index0 %}
              {% if concluido %}
                <div class="dia concluido"></div>
              {% elif index == dia_semana %}
                <div class="dia atual"></div>
              {% else %}
                <div class="dia futuro"></div>
              {% endif %}
            {% endfor %}
          </div>

          <span class="darkgolden">{{ _('Recompensa: 50') }}</span>
          <img
            src="{{ url_for('static', filename='img//stack-of-coins.png') }}"
            class="smallimage"
            alt="moedas"
          />

          {% if semana_completa %}
            <div class="bonus-confirmado">
              ‚úÖ {{ _('Semana conclu√≠da! Voc√™ receber√° sua recompensa.') }}
            </div>
          {% endif %}
        </div>

      </aside>
    </div>

    <script> window.SONS_ATIVOS = {{ 'true' if sons_ativos else 'false' }}; </script>
    <script src="{{ url_for('static', filename='js/sounds.js') }}"></script>
    <script>
      const maisBtn = document.getElementById("openMais");
      const submenuMais = document.getElementById("submenuMais");

      // Alternar visibilidade ao clicar
      maisBtn.addEventListener("click", () => {
        submenuMais.classList.toggle("oculto");
      });

      // Ocultar submenu ao clicar fora
      document.addEventListener("click", (event) => {
        if (!submenuMais.contains(event.target) && !maisBtn.contains(event.target)) {
          submenuMais.classList.add("oculto");
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        
document.getElementById("btnGeralgrl").addEventListener("click", () => trocarRanking("geral"));
document.getElementById("btnAmigosgrl").addEventListener("click", () => trocarRanking("amigos"));
document.getElementById("btnGeralamg").addEventListener("click", () => trocarRanking("geral"));
document.getElementById("btnAmigosamg").addEventListener("click", () => trocarRanking("amigos"));

function trocarRanking(tipo) {
  const geral = document.getElementById("rankingGeral");
  const amigos = document.getElementById("rankingAmigos");

  if (tipo == "geral") {
    geral.classList.remove("oculto");
    amigos.classList.add("oculto");
  } else {
    amigos.classList.remove("oculto");
    geral.classList.add("oculto");
  }
}
        // --- Solicitar amizade ---
        document.querySelectorAll(".friend-request-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.userId;
            const res = await fetch("/solicitar_amizade", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id_destinatario: parseInt(id) }),
            });
            if (res.ok) {
              btn.outerHTML =
                '<button class="waiting-btn" disabled>‚è≥ Aguardando resposta</button>';
            }
          });
        });

        // --- Aceitar amizade ---
        document.querySelectorAll(".accept-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.userId;
            const res = await fetch("/aceitar_amizade", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id_solicitante: parseInt(id) }),
            });
            if (res.ok) {
              btn.parentElement.outerHTML =
                '<button class="friend-btn" disabled>üë• Amigos</button>';
            }
          });
        });

        // --- Recusar amizade ---
        document.querySelectorAll(".reject-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.userId;
            const res = await fetch("/recusar_amizade", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id_solicitante: parseInt(id) }),
            });
            if (res.ok) {
              btn.parentElement.outerHTML = `<button class="friend-request-btn" data-user-id="${id}">ü§ù Solicitar amizade</button>`;
            }
          });
        });
      });
    </script>
    <script>
  // Valor din√¢mico vindo do backend
  window.MUSICA_ATIVA = {{ 'true' if musica_ativa else 'false' }};
  const musicadasessao = {{ musica_tocada | tojson }};
  const volumeMusicaBanco = {{ volume_musica }}
</script>
<script src="{{ url_for('static', filename='js/musics.js') }}"></script>
<script src="{{ url_for('static', filename='js/popup.js') }}"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    {% if session.get('popup_conquistas') %}
      const conquistas = {{ session.get('popup_conquistas') | tojson }};
      let delayTotal = 0;
      
      // Espera o √°udio carregar e o JS principal estar dispon√≠vel
      setTimeout(() => {
        conquistas.forEach((c) => {
          const duracao = c.raridade === "rara" ? 11000 : 5000;
          exibirConquistaPopup(c, delayTotal);
          delayTotal += duracao + 200; // adiciona pequena pausa entre popups
        });
      }, 1000);
    {% endif %}
  });
</script>

  </body>
</html>