<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/128/3975/3975233.png" type="image/x-icon">
  <title>{{ _('quiz_modo_treino_titulo') }} - Aurum</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quiz.css') }}">
</head>
<body {% if tema == 'cla' %} class="claro" {% endif %}>
  <div id="quiz-container" {% if tema == 'cla' %} class="claro" {% endif %}>

    <header class="header header-with-back {% if tema == 'cla' %}claro{% endif %}">
      <a class="back-btn header-with-back__back {% if tema == 'cla' %}claro{% endif %}" href = "{{ url_for('starting_page') }}">← {{ _(' Voltar') }}</a>
      <div>
        <div class="title">{{ _('quiz_modo_treino_titulo') }}</div>
        <div class="meta">{{ _('quiz_modo_treino_instrucao') }}</div>
      </div>

      <div id="meta-right">
        <div id="timer" {% if tema == 'cla' %} class="claro" {% endif %}>{{ _('Tempo') }}: --:--</div>
      </div>
    </header>

    <!-- Intro / botão iniciar -->
    <div id="intro" class="intro">
      <button id="btnStart" class="btn">{{ _('botao_iniciar_quiz') }}</button>
    </div>

    <!-- AREA DO QUIZ (invisível até iniciar) -->
    <div id="quizArea" class="hidden">
      <div class="questions {% if tema == 'cla' %}claro{% endif %}" id="questionsContainer">
        <!-- perguntas geradas via JS -->
      </div>

      <!-- controles (mantive o wrapper caso queira botões extras no futuro) -->
      <div class="controls" aria-hidden="true">
        <!-- botão finalizar removido por opção do fluxo automático -->
      </div>
    </div>



  </div>

  <!-- ===== MODAL PREMIUM DE RESULTADO (M3) ===== -->
  <div id="resultModalOverlay" aria-hidden="true">
    <div id="resultModal" {% if tema == 'cla' %} class="claro" {% endif %} role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div id="modalTitle" {% if tema == 'cla' %} class="claro" {% endif %}></div>
        <div id="modalPercent" aria-live="polite" {% if tema == 'cla' %} class="claro" {% endif %}></div>

        <div class="modal-badges">
            <div id="modalPoints" class="modal-badge" aria-hidden="true" {% if tema == 'cla' %} class="claro" {% endif %}></div>
            <div id="modalCoins" class="modal-badge" aria-hidden="true" {% if tema == 'cla' %} class="claro" {% endif %}></div>
        </div>

        <div id="modalButtons">
            <button id="modalBackBtn" onclick="history.back()" {% if tema == 'cla' %} class="claro" {% endif %}>
                {{ _('Voltar') }}
            </button>
        </div>
    </div>
  </div>

  <!-- scripts (cole o JS abaixo no lugar do script do quiz) -->
  <!-- o JS completo está no bloco 2 -->
</body>
</html>

  <script>
window.SONS_ATIVOS = {{ 'true' if sons_ativos else 'false' }};
</script>
<script src="{{ url_for('static', filename='js/sounds.js') }}"></script>

<script>
/* ------------ LÓGICA DO QUIZ ------------- */

// elementos
const btnStart = document.getElementById('btnStart');
const quizArea = document.getElementById('quizArea');
const intro = document.getElementById('intro');
const questionsContainer = document.getElementById('questionsContainer');
const timerEl = document.getElementById('timer');

const modalOverlay = document.getElementById('resultModalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalPercent = document.getElementById('modalPercent');
const modalPoints = document.getElementById('modalPoints');
const modalCoins = document.getElementById('modalCoins');
const modalBackBtn = document.getElementById('modalBackBtn');

const tema_atual = "{{ tema }}";

let QUESTIONS = [];   // array recebido do backend
let ANSWERS = {};     // id_conteudo -> escolha (índice)
let REMAINING = 0;
let TIMER = null;

// helper time formatter
function formatTime(s){
  const m = Math.floor(s/60);
  const sec = s % 60;
  return `${m}:${sec.toString().padStart(2,'0')}`;
}

// iniciar quiz
btnStart.addEventListener('click', async () => {
  intro.style.display = 'none';
  quizArea.classList.remove('hidden');
  hideModal();

  try {
    const resp = await fetch('/api/quiz/start');
    if (!resp.ok) {
      const err = await resp.json().catch(()=>({error:'Erro'}));
      alert(err.error || "{{ _('Erro ao carregar perguntas.') }}");
      intro.style.display = '';
      quizArea.classList.add('hidden');
      return;
    }

    const data = await resp.json();
    QUESTIONS = data.perguntas || [];
    REMAINING = data.tempo || {{ QUIZ_TIME_SECONDS if QUIZ_TIME_SECONDS is defined else 120 }};

    renderQuestions();
    startTimer();

  } catch (e) {
    alert("{{ _('Erro ao carregar perguntas.') }}");
    intro.style.display = '';
    quizArea.classList.add('hidden');
  }
});

// render das perguntas (usa alternativas já traduzidas vindas do backend)
function renderQuestions(){
  questionsContainer.innerHTML = '';
  ANSWERS = {};

  QUESTIONS.forEach((q, qi) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.dataset.id = q.id_conteudo;

    if (tema_atual === 'cla'){
      card.classList.add("claro")
    }

    const title = document.createElement('div');
    title.className = 'question-title';
    title.textContent = `${qi + 1}. ${q.pergunta}`;
    card.appendChild(title);

    // alternativas: backend envia array de objetos {texto, indice}
    q.alternativas.forEach((alt, ai) => {
      const opt = document.createElement('button');
      opt.className = 'option';

      if (tema_atual === 'cla'){
        opt.classList.add("claro")
      }

      opt.type = 'button';
      opt.textContent = alt.texto ?? alt; // compatibilidade (caso backend envie string)
      opt.dataset.choice = ai;
      opt.onclick = () => handleChoice(q.id_conteudo, ai, opt, card);
      card.appendChild(opt);
    });

    questionsContainer.appendChild(card);
  });
}

// quando usuário escolhe alternativa
async function handleChoice(id_conteudo, choiceIndex, clickedBtn, card){
  if (typeof ANSWERS[id_conteudo] !== 'undefined') return; // já respondeu

  try {
    const resp = await fetch('/api/quiz/check_single', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_conteudo: id_conteudo, choice: choiceIndex })
    });

    if (!resp.ok) {
      alert("{{ _('Erro ao verificar resposta.') }}");
      return;
    }

    const data = await resp.json();
    const acertou = !!data.acertou;

    // marca localmente
    ANSWERS[id_conteudo] = choiceIndex;

    // desabilita opções e aplica classes
    const opts = Array.from(card.querySelectorAll('.option'));
    opts.forEach((b, idx) => {
      b.disabled = true;
      b.classList.add('disabled');
      if (idx === choiceIndex) {
        b.classList.add(acertou ? 'correct' : 'wrong');
      }
    });

    // se todas respondidas -> finalizar automaticamente
    if (Object.keys(ANSWERS).length === QUESTIONS.length) {
      setTimeout(() => finalizeQuiz(), 600);
    }

  } catch (e) {
    alert("{{ _('Erro ao verificar resposta.') }}");
  }
}

// timer principal
function startTimer(){
  timerEl.textContent = '{{ _("Tempo") }}: ' + formatTime(REMAINING);
  if (TIMER) clearInterval(TIMER);

  TIMER = setInterval(() => {
    REMAINING--;
    timerEl.textContent = '{{ _("Tempo") }}: ' + formatTime(REMAINING);

    if (REMAINING <= 0) {
      clearInterval(TIMER);
      finalizeQuiz();
    }
  }, 1000);
}

// mostra modal
function showModal(){
  modalOverlay.style.display = 'flex';
  modalOverlay.setAttribute('aria-hidden', 'false');
}

// esconde modal
function hideModal(){
  modalOverlay.style.display = 'none';
  modalOverlay.setAttribute('aria-hidden', 'true');
}

// finalizar quiz: envia payload para /api/quiz/submit e abre modal
async function finalizeQuiz(){
  if (TIMER) { clearInterval(TIMER); TIMER = null; }

  const payload = { answers: [] };
  QUESTIONS.forEach(q => {
    payload.answers.push({
      id_conteudo: q.id_conteudo,
      choice: (typeof ANSWERS[q.id_conteudo] !== 'undefined') ? ANSWERS[q.id_conteudo] : null
    });
  });

  try {
    const resp = await fetch('/api/quiz/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      alert("{{ _('Erro ao enviar respostas.') }}");
      return;
    }

    const data = await resp.json();

    // calcular percent (backend original não devolve percent)
    const total = data.total ?? payload.answers.length;
    const correct = data.correct ?? 0;
    const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

    modalTitle.textContent = `{{ _('quiz_resultado') }}: ${correct} / ${total}`;
    modalPercent.textContent = `${percent}%`;
    modalPoints.textContent = `+${data.pontos_ganhos ?? 0} {{ _('pontos') }}`;
    modalCoins.textContent = `+${data.moedas_ganhas ?? 0} {{ _('moedas') }}`;

    showModal();

  } catch (e) {
    alert("{{ _('Erro ao enviar respostas.') }}");
  }
}

// inicial: esconder modal
hideModal();

// acessibilidade: tecla ESC fecha modal (não fecha a tela, apenas esconde)
document.addEventListener('keydown', (ev) => {
  if (ev.key === 'Escape' && modalOverlay.style.display === 'flex') {
    hideModal();
  }
});
</script>

<!-- Mantive seus scripts de música abaixo -->
<script>
  window.MUSICA_ATIVA = {{ 'true' if musica_ativa else 'false' }};
</script>
<script src="{{ url_for('static', filename='js/musics.js') }}"></script>
{% if session.get("popup_ranking") %}
<script>
    const popupRanking = {{ session.get("popup_ranking") | tojson }};
    document.addEventListener("DOMContentLoaded", () => {
        abrirModalRanking(popupRanking);
    });
</script>
{% endif %}

